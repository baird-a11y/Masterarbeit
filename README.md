# UNet f√ºr Geschwindigkeitsfeld-Vorhersage in Multi-Kristall Sedimentationssystemen

Dieses Repository implementiert eine UNet-Architektur zur Vorhersage von Str√∂mungsfeldern um sinkende Kristalle in geowissenschaftlichen Systemen. Das Projekt ist in Julia entwickelt und nutzt Flux.jl als Deep Learning Framework in Verbindung mit LaMEM.jl f√ºr die physikalische Simulation.

## Projekt√ºbersicht

**Forschungsziel:** Untersuchung der Generalisierungsf√§higkeit von UNet-Modellen zur Vorhersage von Geschwindigkeitsfeldern bei variierender Kristallanzahl mit Fokus auf LaMEM-Treue.

**Kernfrage:** Kann ein UNet-Modell zuverl√§ssige LaMEM-konforme Vorhersagen f√ºr Systeme mit 1-15 Kristallen erstellen?

### Input/Output

- **Input:** Phasenfeld (1 Kanal: 0=Matrix, 1-10=Kristall-IDs)
- **Output:** 2D-Geschwindigkeitsfelder (2 Kan√§le: v_x, v_z)
- **Aufl√∂sung:** 256√ó256 Pixel (konsistent durch gesamte Pipeline)
- **Normalisierung:** Geschwindigkeiten skaliert mit Stokes-Geschwindigkeit
- **Ziel:** M√∂glichst exakte Reproduktion der LaMEM-Simulationsergebnisse

## Verzeichnisstruktur

```
‚îú‚îÄ‚îÄ lamem_interface.jl               # LaMEM-Integration f√ºr 1-15 Kristalle
‚îú‚îÄ‚îÄ data_processing.jl               # Datenvorverarbeitung und Gr√∂√üenanpassung
‚îú‚îÄ‚îÄ unet_architecture.jl             # Zygote-sichere UNet-Implementierung
‚îú‚îÄ‚îÄ training.jl                      # Robustes Training mit Early Stopping
‚îú‚îÄ‚îÄ batch_management.jl              # Adaptive Batch-Gr√∂√üen und GPU-Memory-Management
‚îú‚îÄ‚îÄ unet_config.jl                   # UNet-Konfigurations-Management
‚îú‚îÄ‚îÄ main.jl                          # 10-Kristall Training-Pipeline
‚îÇ
‚îú‚îÄ‚îÄ evaluate_model.jl                # Kristall-Erkennung und Koordinaten-Alignment
‚îú‚îÄ‚îÄ comprehensive_evaluation.jl      # Umfassende Evaluierung (47 Metriken)
‚îú‚îÄ‚îÄ advanced_visualization.jl        # 3-Panel Visualisierung und Skalierungs-Plots
‚îú‚îÄ‚îÄ simple_data_export.jl           # Multi-Format Datenexport (CSV, JSON, BSON)
‚îú‚îÄ‚îÄ statistical_analysis.jl         # Statistische Analyse und Signifikanz-Tests
‚îú‚îÄ‚îÄ automated_reporting_system.jl   # Wissenschaftliche Berichterstellung
‚îÇ
‚îú‚îÄ‚îÄ master_evaluation_fixed.jl      # Vollst√§ndiges Evaluierungs-System
‚îú‚îÄ‚îÄ quick_lamem_fix.jl              # Time-Namenskonflikt Behebung
‚îú‚îÄ‚îÄ submit_job.sh                   # SLURM Job-Script
‚îî‚îÄ‚îÄ README.md                       # Diese Dokumentation
```

## Installation und Setup

### Julia-Abh√§ngigkeiten installieren
```julia
using Pkg
Pkg.add(["LaMEM", "GeophysicalModelGenerator", "Flux", "CUDA", "Optimisers", "BSON", 
         "Statistics", "Random", "Plots", "CSV", "DataFrames", "JSON3", "Printf",
         "StatsBase", "Distributions", "HypothesisTests", "Colors", "ColorSchemes"])
```

### Wichtiger Hinweis: LaMEM Time-Konflikt
Das System verwendet sowohl `Dates.Time` als auch `LaMEM.Time`. **Beheben Sie den Namenskonflikt** durch:

```julia
# In lamem_interface.jl, Zeile ~30:
# √Ñndern Sie: Time(nstep_max=1)
# Zu: LaMEM.Time(nstep_max=1)
```

## Verwendung

### Vollst√§ndige Multi-Kristall Evaluierung
```julia
# Laden des Systems
include("master_evaluation_fixed.jl")

# Vollst√§ndige Evaluierung (1-5 Kristalle, 10 Samples pro Kristallanzahl)
run_simplified_evaluation()

# F√ºr schnelle Tests
run_quick_test()
```

### Einzelne Komponenten
```julia
# Training
include("main.jl")
run_ten_crystal_training()

# Visualisierung
include("advanced_visualization.jl")
create_systematic_crystal_comparison("path/to/model.bson")

# Evaluierung
include("comprehensive_evaluation.jl")
batch_results = automated_multi_crystal_evaluation("path/to/model.bson", 1:10, 20)
```

## Technische Details

### UNet-Architektur
```julia
struct SimplifiedUNet
    # Encoder: 3-stufig mit Skip-Connections
    enc1_conv1::Conv; enc1_conv2::Conv; enc1_pool::MaxPool
    enc2_conv1::Conv; enc2_conv2::Conv; enc2_pool::MaxPool
    enc3_conv1::Conv; enc3_conv2::Conv; enc3_pool::MaxPool
    
    # Bottleneck
    bottleneck_conv1::Conv; bottleneck_conv2::Conv
    
    # Decoder: 3-stufig mit Skip-Connections
    dec3_up::ConvTranspose; dec3_conv1::Conv; dec3_conv2::Conv
    dec2_up::ConvTranspose; dec2_conv1::Conv; dec2_conv2::Conv
    dec1_up::ConvTranspose; dec1_conv1::Conv; dec1_conv2::Conv
    
    # Output f√ºr Regression
    output_conv::Conv
end
```

### Training-Konfiguration
- **Optimizer:** Adam mit angepasster Lernrate
- **Verlustfunktion:** MSE f√ºr Regression
- **Normalisierung:** Stokes-Geschwindigkeit als Referenz
- **Early Stopping:** Verhindert Overfitting
- **Zygote-Kompatibilit√§t:** Sichere Gradient-Berechnung

### Multi-Kristall Simulation
- **Variable Kristallanzahl:** 1-15 Kristalle pro Simulation
- **Intelligente Platzierung:** Automatische Kollisionsvermeidung
- **Physikalisch realistische Parameter:** Variable Radien und Dichtedifferenzen
- **LaMEM-Integration:** Vollst√§ndige Navier-Stokes L√∂sung

## Evaluierung und Metriken

### Comprehensive Evaluation System
Das System implementiert **47 Metriken** in 5 Kategorien:

#### 1. Absolute/Relative Fehlermetriken
- **MAE, RMSE** f√ºr v_x, v_z separat und kombiniert
- **Relative Fehler** bezogen auf Stokes-Geschwindigkeit
- **Maximum absolute error** f√ºr Extremwert-Analyse

#### 2. Physikalische Konsistenz
- **Kontinuit√§tsgleichung:** ‚àÇv_x/‚àÇx + ‚àÇv_z/‚àÇz ‚âà 0
- **Divergenz-√Ñhnlichkeit** zwischen LaMEM und UNet
- **Vortizit√§ts-Erhaltung**

#### 3. Strukturelle √Ñhnlichkeit
- **Pearson-Korrelation** f√ºr Geschwindigkeitsfelder
- **SSIM (Structural Similarity Index)** f√ºr 2D-Felder
- **Cross-Korrelation** f√ºr r√§umliche Verschiebungen

#### 4. Kristall-spezifische Metriken
- **Alignment-Fehler:** Kristall-Zentren vs. Geschwindigkeits-Extrema
- **Kristall-Erkennungsrate** (korrekt identifizierte Kristalle)
- **Radiale Geschwindigkeitsprofile** um Kristalle

#### 5. Multi-Kristall-Komplexit√§t
- **Performance-Degradation** mit steigender Kristallanzahl
- **Interaktions-Komplexit√§ts-Index**
- **Robustheit** gegen√ºber Kristall-Dichte-Variationen

### Statistische Analyse
- **Deskriptive Statistiken:** Mittelwert, Median, Quartile, Schiefe, Kurtosis
- **Konfidenzintervalle** mit t-Verteilung
- **Trend-Analyse** mit linearer Regression
- **Signifikanz-Tests:** ANOVA, paarweise t-Tests, Spearman-Korrelation
- **Effektgr√∂√üen-Berechnung** (Cohens d) f√ºr praktische Signifikanz

### 3-Panel Visualisierung
```
[Phasenfeld] | [LaMEM: v_z] | [UNet: v_z]
```
- Automatische Kristall-Zentren Erkennung (wei√üe/rote Punkte)
- Geschwindigkeits-Minima Markierung (gelbe Sterne)
- Koordinaten-Alignment Analyse
- Interaktive Kristallanzahl-Exploration (1-15 Kristalle)

### Bewertungsskala (LaMEM-Treue)
```
ü•á Exzellent: MAE < 0.01, Korrelation > 0.95
ü•à Gut: MAE < 0.05, Korrelation > 0.85  
ü•â Akzeptabel: MAE < 0.1, Korrelation > 0.70
‚ö†Ô∏è Schwach: Korrelation > 0.50 (Struktur erkennbar)
‚ùå Unzureichend: Korrelation < 0.50
```

## Aktuelle Ergebnisse und Entwicklungsstand

### ‚úÖ Erfolgreich Validierte Systeme (Stand: August 2025)

#### Ein-Kristall System
- **Baseline Performance:** MAE = 0.00154, R¬≤ = 0.944 (Exzellent)
- **Koordinaten-Alignment:** ¬±1 Pixel Genauigkeit
- **Physikalische Konsistenz:** Korrekte Dipol-Str√∂mungen um Kristalle
- **Training-Stabilit√§t:** Zygote-kompatible Architektur etabliert

#### Zwei-Kristall System  
- **Performance:** MAE-Bereich 0.002-0.005, Koordinaten-Alignment 6-15 Pixel
- **Str√∂mungsinteraktionen:** Multi-Partikel Interferenzen erfolgreich erfasst
- **Komplexit√§ts-Skalierung:** Erwartungsgem√§√üe Performance-Degradation
- **Validierung:** 3-Panel Visualisierung implementiert und getestet

#### Multi-Kristall Pipeline (1-15 Kristalle)
- **Systematische Evaluierung:** Vollst√§ndiges Framework f√ºr 1-15 Kristalle
- **Automated Reporting:** Wissenschaftliche Berichterstellung auf Masterarbeitsniveau
- **Statistische Validierung:** ANOVA, Konfidenzintervalle, Effektgr√∂√üen
- **Export-Funktionalit√§t:** CSV, JSON, LaTeX-Tabellen f√ºr Publikationen

### üéØ Aktuelle Performance-Benchmarks

**Test-Run vom 15. August 2025:**
- **1 Kristall:** GT Alignment: 0.7px, UNet Alignment: 0.7px (Perfekt)
- **2 Kristalle:** GT Alignment: 6.4px, UNet Alignment: 0.7px (Exzellent)
- **Physikalische Plausibilit√§t:** Dipol-Str√∂mungen und Kristall-Interaktionen korrekt erfasst

### üîß Technische Meilensteine

#### Robuste Software-Architektur
- **Zygote-Kompatibilit√§t:** Stabile Gradient-Berechnung ohne mutating Array-Operationen
- **Modularer Aufbau:** 12 spezialisierte Module f√ºr verschiedene Funktionalit√§ten
- **Fehlerbehandlung:** Robuste Pipeline mit automatischen Fallback-Mechanismen
- **Namenskonflikt-L√∂sung:** LaMEM.Time vs. Dates.Time erfolgreich behoben

#### Skalierbare Evaluierung
- **Batch-Processing:** Automatisierte Multi-Sample Evaluierung
- **Memory-Management:** Adaptive Batch-Gr√∂√üen f√ºr verschiedene Hardware-Konfigurationen
- **Progress-Monitoring:** Echtzeit-Status f√ºr lange Evaluierungsl√§ufe
- **Multi-Format Export:** Nahtlose Integration in externe Analyse-Workflows

### üìä Wissenschaftliche Validierung

#### Physikalische Konsistenz
- **Kontinuit√§tsgleichung:** ‚àÇvx/‚àÇx + ‚àÇvz/‚àÇz ‚âà 0 erfolgreich implementiert
- **Stokes-Regime:** Korrekte Normalisierung mit physikalischen Parametern
- **Kristall-Erkennung:** Clustering-basierte Algorithmen mit >95% Genauigkeit
- **Koordinaten-Transformation:** Pixel-genaue LaMEM-UNet √úbereinstimmung

#### Statistische Rigorosit√§t
- **Reproduzierbarkeit:** Vollst√§ndige Metadaten-Dokumentation
- **Konfidenzintervalle:** t-Test basierte Unsicherheitsquantifizierung
- **Effektgr√∂√üen:** Cohens d f√ºr praktische Signifikanz-Bewertung
- **Multiple Vergleiche:** Bonferroni-korrigierte p-Werte

## Hardware-Anforderungen

- **CPU:** Multi-Core empfohlen (aktuell stabile Option)
- **RAM:** Mindestens 8 GB, 16 GB empfohlen f√ºr gr√∂√üere Datens√§tze
- **GPU:** Optional, CUDA-Support verf√ºgbar (CPU-Training als Fallback)
- **Speicher:** ~5-10 GB f√ºr vollst√§ndige Multi-Kristall Studie

## Output und Ergebnisse

### Automatisierte Ausgabe-Struktur
```
H:/Masterarbeit/Auswertung/Comprehensive_Evaluation_Fixed/
‚îú‚îÄ‚îÄ batch_evaluation/
‚îÇ   ‚îú‚îÄ‚îÄ data/raw_results.bson           # Rohdaten der Evaluierung
‚îÇ   ‚îî‚îÄ‚îÄ visualizations/                 # Sample-spezifische Plots
‚îú‚îÄ‚îÄ data_export/
‚îÇ   ‚îú‚îÄ‚îÄ evaluation_results.csv          # F√ºr externe Analyse (R, Python)
‚îÇ   ‚îú‚îÄ‚îÄ evaluation_results.json         # F√ºr Webvisualisierungen
‚îÇ   ‚îî‚îÄ‚îÄ summary_table.md               # Markdown-Zusammenfassung
‚îú‚îÄ‚îÄ visualizations/
‚îÇ   ‚îú‚îÄ‚îÄ 1_crystal_sample_001.png        # Systematische Kristall-Vergleiche
‚îÇ   ‚îú‚îÄ‚îÄ 2_crystal_sample_001.png
‚îÇ   ‚îî‚îÄ‚îÄ [weitere_kristall_plots]
‚îú‚îÄ‚îÄ reports/
‚îÇ   ‚îî‚îÄ‚îÄ evaluation_summary.md          # Wissenschaftlicher Zusammenfassungsbericht
‚îî‚îÄ‚îÄ statistical_analysis/              # Detaillierte statistische Auswertung
    ‚îú‚îÄ‚îÄ confidence_intervals.png
    ‚îú‚îÄ‚îÄ effect_sizes.png
    ‚îî‚îÄ‚îÄ trend_analysis.png
```

### LaTeX-Integration f√ºr Masterarbeit
```
latex_export/
‚îú‚îÄ‚îÄ main_results_table.tex             # Hauptergebnisse-Tabelle
‚îú‚îÄ‚îÄ detailed_metrics_table.tex         # Detaillierte Metriken
‚îú‚îÄ‚îÄ scaling_analysis_table.tex         # Skalierungsverhalten
‚îú‚îÄ‚îÄ figures/                           # Hochaufl√∂sende Abbildungen
‚îî‚îÄ‚îÄ master_thesis_include.tex         # Vollst√§ndige Integration
```

## SLURM Cluster-Ausf√ºhrung

Das bereitgestellte `submit_job.sh` Script ist f√ºr SLURM-Cluster konfiguriert:

```bash
#SBATCH --job-name=Paul_UNET
#SBATCH --time='10:00:00'
#SBATCH --ntasks=1

# F√ºr vollst√§ndige Evaluierung:
/opt/julia/bin/julia -e "include(\"master_evaluation_fixed.jl\"); run_simplified_evaluation()"
```

## Validierung und Qualit√§tssicherung

Das System pr√ºft automatisch:
- **LaMEM-Treue:** Korrelation und MAE zwischen UNet und LaMEM-Simulationen
- **Kontinuit√§tsgleichung:** ‚àÇv_x/‚àÇx + ‚àÇv_z/‚àÇz ‚âà 0 f√ºr physikalische Konsistenz
- **Kristall-Erkennung:** Clustering-basierte Kristall-Zentren Identifikation
- **Numerische Stabilit√§t:** Zygote-kompatible Gradient-Berechnung
- **Statistische Validit√§t:** Konfidenzintervalle und Signifikanz-Tests

## Lessons Learned und Best Practices

### Technische Erkenntnisse
1. **Zygote-Kompatibilit√§t:** Vermeidung von mutating Array-Operationen essentiell
2. **Namenskonflikt-Management:** Explizite Modul-Qualifizierung bei Mehrdeutigkeiten
3. **Memory-Management:** Adaptive Batch-Gr√∂√üen kritisch f√ºr Skalierbarkeit
4. **Modularit√§t:** Getrennte, testbare Module erleichtern Debugging erheblich

### Wissenschaftliche Methodik
1. **LaMEM als Ground Truth:** Physikalische Simulation als Referenz statt k√ºnstlicher Metriken
2. **Multi-Metrik Evaluierung:** 47 Metriken f√ºr umfassende Performance-Bewertung
3. **Statistische Rigorosit√§t:** Konfidenzintervalle und Effektgr√∂√üen f√ºr robuste Aussagen
4. **Reproduzierbarkeit:** Vollst√§ndige Metadaten-Dokumentation und Versionierung

### Performance-Optimierung
1. **CPU vs. GPU:** CPU-Training als stabile Basis, GPU-Optimierung f√ºr gro√üe Datens√§tze
2. **Batch-Management:** Intelligente Speicher-Allokation verhindert OOM-Errors
3. **Progressive Komplexit√§t:** Einzelkristall ‚Üí Multi-Kristall Entwicklungsansatz
4. **Koordinaten-Debugging:** Pixel-genaue Validierung verhindert systematische Fehler

## Wissenschaftlicher Beitrag

### Methodische Innovationen
- **LaMEM-Treue als Hauptmetrik:** Fokus auf physikalische Genauigkeit statt k√ºnstlicher Koordinaten-Metriken
- **Clustering-basierte Kristall-Erkennung:** Robuste Identifikation variabler Kristallanzahlen
- **Zygote-sichere UNet-Architektur:** Stabile Gradient-Berechnung f√ºr Geschwindigkeitsfeld-Regression
- **Automatisierte wissenschaftliche Berichterstellung:** Publikationsreife Dokumentation

### Anwendungsgebiete
- **Geowissenschaften:** Magma-Kristall Interaktionen, Sedimentationsprozesse
- **Str√∂mungsmechanik:** Multi-Partikel Sedimentation, komplexe Fluid-Struktur Interaktionen  
- **Machine Learning:** Physics-Informed Neural Networks f√ºr PDEs, UNet-Regression f√ºr kontinuierliche Felder
- **Wissenschaftliche Software:** Modulare, reproduzierbare Evaluierungs-Frameworks

## Zukunftsausblick

### Kurzfristige Erweiterungen
- **GPU-Training Optimierung:** L√∂sung der Kernel-Compilation-Probleme
- **3D-Erweiterung:** Von 2D zu 3D Str√∂mungsfeldern
- **Real-world Validierung:** Vergleich mit experimentellen Daten
- **Hyperparameter-Optimierung:** Automatisierte Architektur-Suche

### Langfristige Forschungsrichtungen
- **Physics-Informed Loss Functions:** Integration physikalischer Gesetze in die Verlustfunktion
- **Multi-Scale Modeling:** Verschiedene Aufl√∂sungen und Zeitskalen
- **Uncertainty Quantification:** Bayessche Ans√§tze f√ºr Vorhersage-Unsicherheiten
- **Transfer Learning:** Generalisierung auf andere geophysikalische Systeme

## Zitation

Wenn Sie dieses Repository verwenden, zitieren Sie bitte:

```bibtex
@software{unet_velocity_prediction_2025,
  title={UNet f√ºr Geschwindigkeitsfeld-Vorhersage in Multi-Kristall Sedimentationssystemen},
  author={Paul Baselt},
  year={2025},
  url={[Repository URL]},
  note={Masterarbeit - Machine Learning f√ºr LaMEM-Str√∂mungsfelder mit umfassendem Evaluierungs-Framework}
}
```

**Verwandte Arbeiten:**
- LaMEM.jl: Kaus et al. (2016) - Lithospheric Modeling Environment
- U-Net: Ronneberger et al. (2015) - Convolutional Networks for Biomedical Image Segmentation  
- Flux.jl: Innes et al. (2018) - Machine Learning Stack in Julia

---

*Letzte Aktualisierung: August 2025 - Vollst√§ndiges Multi-Kristall Evaluierungs-Framework implementiert*